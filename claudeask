#!/bin/bash

# Configuration
REPOS_DIR="$HOME/.claudeask/repos"

# Ensure directories exist
mkdir -p "$REPOS_DIR"

INPUT=$1

if [ -z "$INPUT" ]; then
    # No argument: list existing repos and let user pick
    REPOS=()
    while IFS= read -r dir; do
        REPOS+=("$(basename "$dir")")
    done < <(find "$REPOS_DIR" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | sort)

    if [ ${#REPOS[@]} -eq 0 ]; then
        echo "No repositories found. Clone one first:"
        echo "  claudeask <github-repo-url-or-name>"
        echo "  Example: claudeask anomalyco/opencode"
        exit 1
    fi

    REPO_REL_PATH=$(printf '%s\n' "${REPOS[@]}" | fzf --height=~20 --prompt="Select a repository: ")
    if [ -z "$REPO_REL_PATH" ]; then
        echo "No repository selected."
        exit 1
    fi
elif [[ "$INPUT" =~ ^https:// || "$INPUT" =~ ^git@ ]]; then
    # Full URL
    REPO_URL="$INPUT"
    REPO_REL_PATH=$(echo "$REPO_URL" | sed -E 's|.*github.com[:/](.*)|\1|' | sed 's|\.git$||')
    REPO_REL_PATH=$(basename "$REPO_REL_PATH")
else
    # Shorthand: owner/repo
    REPO_URL="https://github.com/$INPUT.git"
    REPO_REL_PATH=$(basename "$INPUT")
fi

TARGET_DIR="$REPOS_DIR/$REPO_REL_PATH"

if [ -d "$TARGET_DIR" ]; then
    cd "$TARGET_DIR" || exit 1
    if [ -d ".git" ]; then
        echo "Pulling latest changes..."
        git pull
    fi
else
    echo "Cloning $REPO_URL into $TARGET_DIR..."
    git clone "$REPO_URL" "$TARGET_DIR"
    cd "$TARGET_DIR" || exit 1
fi

echo "Launching Claude Code..."
claude .
